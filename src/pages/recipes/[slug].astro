---
import { getCollection } from "astro:content";
import Layout from "@layouts/recipe.astro";
import formatIngredients from "@utils/meals/parseIngredients";
import type { RecipeContent, Ingredient, Category } from "@ts/meals";
import IngredientItem from "@components/meals/ingredient.astro";
import { Picture } from '@astrojs/image/components';
import Categories from "@components/meals/categories.astro";
import {recipeCategories} from "@utils/meals/categories";

export async function getStaticPaths() {
  const recipes = await getCollection("recipes");

  return recipes.map((r) => ({
    params: { slug: r.slug },
    props: { recipe: r },
  }));
}

const recipe: RecipeContent = Astro.props.recipe;
const { Content } = await recipe.render();
const ingredients: Ingredient[] = formatIngredients(recipe.data.ingredients);
const categories: Category[] | null = recipe.data.categories ? recipeCategories(recipe.data.categories): null
---

<style>
  .image {
    width: 100%;
    max-width: 400px;

    @media(min-width: 40em) {
        width: 40%;
		margin-left: 20px;
        float: right;
    }
  }

  article {
    clear: both;
    overflow: hidden;
  }
</style>

<Layout>
	<article>
		<header>
			<h1>{recipe.data.title}</h1>
			{recipe.data.image && 
				<Picture
					class='image'
					src={recipe.data.image}
					alt={`Photo of ${recipe.data.title}`}
					widths={[400]}
					aspectRatio={1}
					sizes={''}
					formats={['avif', 'webp', 'jpeg']}
				/>
			}
			{categories && <Categories categories={categories} />}
		</header>
		<h2>Ingredients</h2>
		<ul>
			{
			ingredients.map((i) => (
				<li>
				<IngredientItem {...i} />
				</li>
			))
			}
		</ul>
		<h2>Method</h2>
		<Content />
	</article>
</Layout>
